<div class="incidents-container">
  <p-toast position="top-right" styleClass="p-toast-sm"></p-toast>
  <p-confirmDialog
    acceptLabel="Yes"
    rejectLabel="No"
    acceptIcon="pi pi-check"
    rejectIcon="pi pi-times"
    acceptButtonStyleClass="p-button-danger"
    rejectButtonStyleClass="p-button-outlined"
  ></p-confirmDialog>

  <!-- Enhanced Header -->
  <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6 mb-6">
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
      <div class="flex-1">
        <h1 class="text-3xl font-bold bg-gradient-to-r from-red-600 to-orange-600 bg-clip-text text-transparent mb-2">
          Incident Management
        </h1>
        <p class="text-gray-600 text-sm">
          Track and manage mission incidents with document and image uploads
        </p>
      </div>
      
      <div class="flex flex-wrap gap-3">
        <!-- Add Incident Button -->
        <button
          type="button"
          pButton
          icon="pi pi-plus"
          label="Add Incident"
          class="p-button-primary"
          styleClass="bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 border-0 shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200"
          (click)="showAddDialog()"
        ></button>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
      <div class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 rounded-xl p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-red-600 text-sm font-medium">Total Incidents</p>
            <p class="text-2xl font-bold text-red-800">{{ totalItems }}</p>
          </div>
          <div class="bg-red-100 p-3 rounded-lg">
            <i class="pi pi-exclamation-triangle text-red-600 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-gradient-to-r from-yellow-50 to-amber-50 border border-yellow-200 rounded-xl p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-yellow-600 text-sm font-medium">In Progress</p>
            <p class="text-2xl font-bold text-yellow-800">
              {{ inProgressCount }}
            </p>
          </div>
          <div class="bg-yellow-100 p-3 rounded-lg">
            <i class="pi pi-clock text-yellow-600 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-green-600 text-sm font-medium">Resolved</p>
            <p class="text-2xl font-bold text-green-800">
              {{ resolvedCount }}
            </p>
          </div>
          <div class="bg-green-100 p-3 rounded-lg">
            <i class="pi pi-check-circle text-green-600 text-xl"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6 mb-6">
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-4">
      <h3 class="text-lg font-semibold text-gray-800">Filters</h3>
      <div class="flex gap-2">
        <button
          pButton
          type="button"
          icon="pi pi-filter"
          label="Apply Filters"
          class="p-button-primary"
          (click)="applyFilters()"
        ></button>
        <button
          pButton
          type="button"
          icon="pi pi-times"
          label="Clear Filters"
          class="p-button-outlined"
          [disabled]="!hasActiveFilters"
          (click)="clearFilters()"
        ></button>
      </div>
    </div>

    <form [formGroup]="filterForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
      <!-- Mission Filter -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">Mission</label>
        <p-dropdown
          formControlName="missionId"
          [options]="missions"
          optionLabel="service"
          optionValue="missionId"
          placeholder="All Missions"
          styleClass="w-full"
          [showClear]="true"
          inputStyleClass="p-3 text-sm bg-gray-50 border border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200"
          appendTo="body"
        >
          <ng-template pTemplate="selectedItem" let-mission>
            <div class="flex items-center gap-2">
              <i class="pi pi-briefcase text-red-600"></i>
              <span>{{ mission.service }} - {{ mission.requester }}</span>
            </div>
          </ng-template>
          <ng-template pTemplate="item" let-mission>
            <div class="flex items-center gap-2">
              <i class="pi pi-briefcase text-red-600"></i>
              <span>{{ mission.service }} - {{ mission.requester }}</span>
            </div>
          </ng-template>
        </p-dropdown>
      </div>

      <!-- Type Filter -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">Type</label>
        <p-dropdown
          formControlName="type"
          [options]="typeOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="All Types"
          styleClass="w-full"
          [showClear]="true"
          inputStyleClass="p-3 text-sm bg-gray-50 border border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200"
          appendTo="body"
        ></p-dropdown>
      </div>

      <!-- Status Filter -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">Status</label>
        <p-dropdown
          formControlName="status"
          [options]="statusOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="All Statuses"
          styleClass="w-full"
          [showClear]="true"
          inputStyleClass="p-3 text-sm bg-gray-50 border border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200"
          appendTo="body"
        ></p-dropdown>
      </div>

      <!-- Start Date Filter -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">Start Date</label>
        <div class="relative">
          <input
            type="date"
            formControlName="reportDateStart"
            class="w-full p-3 text-sm bg-gray-50 border border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200 custom-date-input"
            placeholder="Start date"
          />
          <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
            <i class="pi pi-calendar text-gray-400"></i>
          </div>
        </div>
      </div>

      <!-- End Date Filter -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">End Date</label>
        <div class="relative">
          <input
            type="date"
            formControlName="reportDateEnd"
            class="w-full p-3 text-sm bg-gray-50 border border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200 custom-date-input"
            placeholder="End date"
          />
          <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
            <i class="pi pi-calendar text-gray-400"></i>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Incidents Table -->
  <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
    <div class="overflow-x-auto">
      <p-table
        [value]="incidents"
        [loading]="loading"
        styleClass="p-datatable-striped p-datatable-sm"
        responsiveLayout="stack"
        [breakpoint]="'960px'"
        dataKey="incidentId"
        [paginator]="true"
        [rows]="itemsPerPage"
        [totalRecords]="totalItems"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
        [rowsPerPageOptions]="[5, 10, 25, 50]"
        (onLazyLoad)="onPageChange($event)"
        lazy="true"
      >
        <ng-template pTemplate="header">
          <tr class="bg-gradient-to-r from-gray-50 to-gray-100">
            <th class="py-4 px-4 min-w-[120px]">
              <div class="flex items-center gap-2">
                <i class="pi pi-tag text-gray-500"></i>
                Type
              </div>
            </th>
            <th class="py-4 px-4 min-w-[200px]">
              <div class="flex items-center gap-2">
                <i class="pi pi-briefcase text-gray-500"></i>
                Mission
              </div>
            </th>
            <th class="py-4 px-4 min-w-[200px]">
              <div class="flex items-center gap-2">
                <i class="pi pi-align-left text-gray-500"></i>
                Description
              </div>
            </th>
            <th class="py-4 px-4 min-w-[120px]">
              <div class="flex items-center gap-2">
                <i class="pi pi-info-circle text-gray-500"></i>
                Status
              </div>
            </th>
            <th class="py-4 px-4 min-w-[150px]">
              <div class="flex items-center gap-2">
                <i class="pi pi-calendar text-gray-500"></i>
                Report Date
              </div>
            </th>
            <th class="py-4 px-4 min-w-[120px]">
              <div class="flex items-center gap-2">
                <i class="pi pi-file text-gray-500"></i>
                Documents
              </div>
            </th>
            <th class="py-4 px-4 min-w-[150px]">
              <div class="flex items-center gap-2">
                <i class="pi pi-cog text-gray-500"></i>
                Actions
              </div>
            </th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-incident>
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="py-4 px-4">
              <p-tag 
                [value]="getTypeLabel(incident.type)" 
                [severity]="getTypeSeverity(incident.type)"
                styleClass="text-xs font-semibold"
              ></p-tag>
            </td>
            <td class="py-4 px-4">
              <div class="font-medium text-gray-900">
                {{ getMissionTitle(incident.missionId) }}
              </div>
            </td>
            <td class="py-4 px-4">
              <div class="text-gray-700 max-w-xs truncate" [title]="incident.description">
                {{ incident.description }}
              </div>
            </td>
            <td class="py-4 px-4">
              <p-tag 
                [value]="getStatusLabel(incident.status)" 
                [severity]="getStatusSeverity(incident.status)"
                styleClass="text-xs font-semibold"
              ></p-tag>
            </td>
            <td class="py-4 px-4">
              <div class="text-gray-600">
                {{ incident.reportDate | date: 'MMM dd, yyyy' }}
              </div>
            </td>
            <td class="py-4 px-4">
              <div class="flex items-center gap-2">
                <span class="text-sm text-gray-500">
                  {{ incident.incidentDocsUrls?.length || 0 }} files
                </span>
                <button
                  *ngIf="incident.incidentDocsUrls && incident.incidentDocsUrls.length > 0"
                  pButton
                  type="button"
                  icon="pi pi-eye"
                  class="p-button-text p-button-sm"
                  pTooltip="View Documents"
                  (click)="viewFiles(incident)"
                ></button>
              </div>
            </td>
            <td class="py-4 px-4">
              <div class="flex gap-2">
                <button
                  pButton
                  type="button"
                  icon="pi pi-pencil"
                  class="p-button-text p-button-sm p-button-primary"
                  pTooltip="Edit"
                  (click)="showEditDialog(incident)"
                ></button>
                <button
                  pButton
                  type="button"
                  icon="pi pi-trash"
                  class="p-button-text p-button-sm p-button-danger"
                  pTooltip="Delete"
                  (click)="deleteIncident(incident)"
                ></button>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7" class="py-8 px-4 text-center">
              <div class="flex flex-col items-center gap-4 text-gray-500">
                <i class="pi pi-exclamation-triangle text-4xl"></i>
                <div>
                  <p class="text-lg font-medium">No incidents found</p>
                  <p class="text-sm">Start by adding your first incident</p>
                </div>
                <button
                  pButton
                  type="button"
                  icon="pi pi-plus"
                  label="Add Incident"
                  class="p-button-primary"
                  (click)="showAddDialog()"
                ></button>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Add/Edit Incident Dialog -->
  <p-dialog
    [(visible)]="displayDialog"
    [header]="isEditMode ? 'Edit Incident' : 'Add Incident'"
    [modal]="true"
    [style]="{ width: '700px' }"
    [draggable]="false"
    [resizable]="false"
    styleClass="modern-dialog"
  >
    <form [formGroup]="incidentForm" (ngSubmit)="saveIncident()" class="space-y-4">
      <!-- Mission Selection -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">Mission</label>
        <p-dropdown
          formControlName="missionId"
          [options]="missions"
          optionLabel="service"
          optionValue="missionId"
          placeholder="Select mission"
          styleClass="w-full"
          [showClear]="true"
          inputStyleClass="p-3 text-sm bg-gray-50 border border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200"
          appendTo="body"
        >
          <ng-template pTemplate="selectedItem" let-mission>
            <div class="flex items-center gap-2">
              <i class="pi pi-briefcase text-red-600"></i>
              <span>{{ mission.service }} - {{ mission.requester }}</span>
            </div>
          </ng-template>
          <ng-template pTemplate="item" let-mission>
            <div class="flex items-center gap-2">
              <i class="pi pi-briefcase text-red-600"></i>
              <span>{{ mission.service }} - {{ mission.requester }}</span>
            </div>
          </ng-template>
        </p-dropdown>
      </div>

      <!-- Incident Type -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">Incident Type</label>
        <p-dropdown
          formControlName="type"
          [options]="typeOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Select incident type"
          styleClass="w-full"
          [showClear]="true"
          inputStyleClass="p-3 text-sm bg-gray-50 border border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200"
          appendTo="body"
        ></p-dropdown>
      </div>

      <!-- Description -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">Description</label>
        <textarea
          pInputTextarea
          formControlName="description"
          placeholder="Describe the incident..."
          rows="3"
          class="w-full p-3 text-sm bg-gray-50 border border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200"
          maxlength="500"
        ></textarea>
        <div class="flex justify-between text-xs text-gray-500 mt-1">
          <span>Maximum 500 characters</span>
          <span>{{ incidentForm.get('description')?.value?.length || 0 }}/500</span>
        </div>
      </div>

      <!-- Status -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">Status</label>
        <p-dropdown
          formControlName="status"
          [options]="statusOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Select status"
          styleClass="w-full"
          [showClear]="true"
          inputStyleClass="p-3 text-sm bg-gray-50 border border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200"
          appendTo="body"
        ></p-dropdown>
      </div>

      <!-- Report Date -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">Report Date</label>
        <div class="relative">
          <input
            type="date"
            formControlName="reportDate"
            [max]="getCurrentDateString()"
            class="w-full p-3 text-sm bg-gray-50 border border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200 custom-date-input"
            placeholder="Select date"
          />
          <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
            <i class="pi pi-calendar text-gray-400"></i>
          </div>
        </div>
      </div>

      <!-- Incident Documents -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">Incident Documents (Optional)</label>
        <p-fileUpload
          #fileUpload
          [multiple]="true"
          [maxFileSize]="10485760"
          accept="image/*,.pdf,.doc,.docx"
          [customUpload]="true"
          (onSelect)="onFileSelect($event)"
          (onClear)="uploadedFiles = []"
          chooseLabel="Choose Files"
          cancelLabel="Clear"
          styleClass="w-full"
          [auto]="true"
        >
          <ng-template pTemplate="content">
            <div *ngIf="uploadedFiles.length > 0" class="mt-4">
              <h6 class="text-sm font-medium text-gray-700 mb-2">Selected Files:</h6>
              <div class="space-y-2">
                <div 
                  *ngFor="let file of uploadedFiles; let i = index" 
                  class="flex items-center justify-between p-2 bg-gray-50 rounded-lg"
                >
                  <div class="flex items-center gap-2">
                    <i class="pi pi-file text-red-600"></i>
                    <span class="text-sm text-gray-700">{{ file.name }}</span>
                    <span class="text-xs text-gray-500">({{ (file.size / 1024 / 1024).toFixed(2) }} MB)</span>
                  </div>
                  <button
                    type="button"
                    pButton
                    icon="pi pi-times"
                    class="p-button-text p-button-sm p-button-danger"
                    (click)="removeFile(file)"
                  ></button>
                </div>
              </div>
            </div>
          </ng-template>
        </p-fileUpload>
        <p class="text-xs text-gray-500 mt-1">
          Maximum 10 files, 10MB each. Supported formats: JPEG, PNG, GIF, PDF, DOC, DOCX
        </p>
      </div>
    </form>

    <ng-template pTemplate="footer">
      <div class="flex justify-end gap-3">
        <button
          pButton
          type="button"
          label="Cancel"
          class="p-button-outlined"
          (click)="closeDialog()"
        ></button>
        <button
          pButton
          type="button"
          [label]="isEditMode ? 'Update' : 'Save'"
          [icon]="isEditMode ? 'pi pi-check' : 'pi pi-plus'"
          class="p-button-primary"
          [loading]="loading"
          [disabled]="incidentForm.invalid || loading"
          (click)="saveIncident()"
        ></button>
      </div>
    </ng-template>
  </p-dialog>

  <!-- File Gallery Modal -->
  <p-dialog
    [(visible)]="showFileGallery"
    header="Incident Documents"
    [modal]="true"
    [style]="{ width: '90vw', maxWidth: '800px', height: '80vh' }"
    [draggable]="false"
    [resizable]="false"
    styleClass="file-gallery-dialog"
    (onHide)="closeFileGallery()"
  >
    <div *ngIf="selectedFiles.length > 0" class="relative h-full">
      <!-- File Navigation -->
      <div class="absolute top-4 left-4 z-10 flex items-center gap-2 bg-black bg-opacity-50 text-white px-3 py-2 rounded-lg">
        <span class="text-sm font-medium">
          {{ currentFileIndex + 1 }} / {{ selectedFiles.length }}
        </span>
      </div>

      <!-- Close Button -->
      <button
        (click)="closeFileGallery()"
        class="absolute top-4 right-4 z-10 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70 transition-all duration-200"
      >
        <i class="pi pi-times"></i>
      </button>

      <!-- Previous Button -->
      <button
        *ngIf="currentFileIndex > 0"
        (click)="previousFile()"
        class="absolute left-4 top-1/2 transform -translate-y-1/2 z-10 bg-black bg-opacity-50 text-white p-3 rounded-full hover:bg-opacity-70 transition-all duration-200"
      >
        <i class="pi pi-chevron-left"></i>
      </button>

      <!-- Next Button -->
      <button
        *ngIf="currentFileIndex < selectedFiles.length - 1"
        (click)="nextFile()"
        class="absolute right-4 top-1/2 transform -translate-y-1/2 z-10 bg-black bg-opacity-50 text-white p-3 rounded-full hover:bg-opacity-70 transition-all duration-200"
      >
        <i class="pi pi-chevron-right"></i>
      </button>

      <!-- Current File -->
      <div class="flex items-center justify-center h-full">
        <div *ngIf="isImageFile(selectedFiles[currentFileIndex])" class="max-w-full max-h-full">
          <img
            [src]="getFileUrl(selectedFiles[currentFileIndex])"
            [alt]="'Document ' + (currentFileIndex + 1)"
            class="max-w-full max-h-full object-contain rounded-lg shadow-lg"
          />
        </div>
        <div *ngIf="!isImageFile(selectedFiles[currentFileIndex])" class="text-center">
          <i class="pi pi-file-pdf text-6xl text-gray-400 mb-4"></i>
          <p class="text-gray-600 mb-4">PDF or Document File</p>
          <a
            [href]="getFileUrl(selectedFiles[currentFileIndex])"
            target="_blank"
            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors duration-200"
          >
            <i class="pi pi-external-link mr-2"></i>
            Open Document
          </a>
        </div>
      </div>

      <!-- Thumbnail Navigation -->
      <div *ngIf="selectedFiles.length > 1" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 z-10">
        <div class="flex gap-2 bg-black bg-opacity-50 p-2 rounded-lg">
          <div
            *ngFor="let file of selectedFiles; let i = index"
            (click)="selectFile(i)"
            [class]="i === currentFileIndex ? 'ring-2 ring-white' : 'opacity-60 hover:opacity-100'"
            class="w-16 h-16 rounded-lg overflow-hidden cursor-pointer transition-all duration-200 bg-gray-100 flex items-center justify-center"
          >
            <img
              *ngIf="isImageFile(file)"
              [src]="getFileUrl(file)"
              [alt]="'Thumbnail ' + (i + 1)"
              class="w-full h-full object-cover"
            />
            <i
              *ngIf="!isImageFile(file)"
              class="pi pi-file text-gray-500 text-xl"
            ></i>
          </div>
        </div>
      </div>
    </div>
  </p-dialog>
</div> 