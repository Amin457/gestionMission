<div class="mission-costs-container">
  <p-toast position="top-right" styleClass="p-toast-sm"></p-toast>
  <p-confirmDialog
    acceptLabel="Yes"
    rejectLabel="No"
    acceptIcon="pi pi-check"
    rejectIcon="pi pi-times"
    acceptButtonStyleClass="p-button-danger"
    rejectButtonStyleClass="p-button-outlined"
  ></p-confirmDialog>

  <!-- Enhanced Header -->
  <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6 mb-6">
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
      <div class="flex-1">
        <h1 class="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2">
          Mission Costs Management
        </h1>
        <p class="text-gray-600 text-sm">
          Track and manage all mission-related expenses with receipt photo uploads
        </p>
      </div>
      
      <div class="flex flex-wrap gap-3">
        <!-- Add Cost Button -->
        <button
          type="button"
          pButton
          icon="pi pi-plus"
          label="Add Cost"
          class="p-button-primary"
          styleClass="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 border-0 shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200"
          (click)="showAddDialog()"
        ></button>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-blue-600 text-sm font-medium">Total Costs</p>
            <p class="text-2xl font-bold text-blue-800">{{ totalItems }}</p>
          </div>
          <div class="bg-blue-100 p-3 rounded-lg">
            <i class="pi pi-dollar text-blue-600 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-green-600 text-sm font-medium">Total Amount</p>
            <p class="text-2xl font-bold text-green-800">${{ totalCost.toFixed(2) }}</p>
          </div>
          <div class="bg-green-100 p-3 rounded-lg">
            <i class="pi pi-chart-line text-green-600 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-xl p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-purple-600 text-sm font-medium">Avg. Cost</p>
            <p class="text-2xl font-bold text-purple-800">
              ${{ totalItems > 0 ? (totalCost / totalItems).toFixed(2) : '0.00' }}
            </p>
          </div>
          <div class="bg-purple-100 p-3 rounded-lg">
            <i class="pi pi-calculator text-purple-600 text-xl"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6 mb-6">
    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-4">
      <h3 class="text-lg font-semibold text-gray-800">Filters</h3>
      <div class="flex gap-2">
        <button
          pButton
          type="button"
          icon="pi pi-filter"
          label="Apply Filters"
          class="p-button-primary"
          (click)="applyFilters()"
        ></button>
        <button
          pButton
          type="button"
          icon="pi pi-times"
          label="Clear Filters"
          class="p-button-outlined"
          [disabled]="!hasActiveFilters"
          (click)="clearFilters()"
        ></button>
      </div>
    </div>

    <form [formGroup]="filterForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
      <!-- Mission Filter -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">Mission</label>
        <p-dropdown
          formControlName="missionId"
          [options]="missions"
          optionLabel="service"
          optionValue="missionId"
          placeholder="All Missions"
          styleClass="w-full"
          [showClear]="true"
          inputStyleClass="p-3 text-sm bg-gray-50 border border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200"
          appendTo="body"
        >
          <ng-template pTemplate="selectedItem" let-mission>
            <div class="flex items-center gap-2">
              <i class="pi pi-briefcase text-indigo-600"></i>
              <span>{{ mission.service }} - {{ mission.requester }}</span>
            </div>
          </ng-template>
          <ng-template pTemplate="item" let-mission>
            <div class="flex items-center gap-2">
              <i class="pi pi-briefcase text-indigo-600"></i>
              <span>{{ mission.service }} - {{ mission.requester }}</span>
            </div>
          </ng-template>
        </p-dropdown>
      </div>

      <!-- Type Filter -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">Type</label>
        <p-dropdown
          formControlName="type"
          [options]="typeOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="All Types"
          styleClass="w-full"
          [showClear]="true"
          inputStyleClass="p-3 text-sm bg-gray-50 border border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200"
          appendTo="body"
        ></p-dropdown>
      </div>

      <!-- Min Amount Filter -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">Min Amount</label>
        <input
          pInputText
          type="number"
          formControlName="minAmount"
          placeholder="Min amount"
          class="w-full p-3 text-sm bg-gray-50 border border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200"
          step="0.01"
          min="0"
        />
      </div>

      <!-- Max Amount Filter -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">Max Amount</label>
        <input
          pInputText
          type="number"
          formControlName="maxAmount"
          placeholder="Max amount"
          class="w-full p-3 text-sm bg-gray-50 border border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200"
          step="0.01"
          min="0"
        />
      </div>

      <!-- Start Date Filter -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">Start Date</label>
        <div class="relative">
          <input
            type="date"
            formControlName="dateStart"
            class="w-full p-3 text-sm bg-gray-50 border border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 custom-date-input"
            placeholder="Start date"
          />
          <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
            <i class="pi pi-calendar text-gray-400"></i>
          </div>
        </div>
      </div>

      <!-- End Date Filter -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">End Date</label>
        <div class="relative">
          <input
            type="date"
            formControlName="dateEnd"
            class="w-full p-3 text-sm bg-gray-50 border border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 custom-date-input"
            placeholder="End date"
          />
          <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
            <i class="pi pi-calendar text-gray-400"></i>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Costs Table -->
  <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
    <div class="overflow-x-auto">
      <p-table
        [value]="costs"
        [loading]="loading"
        styleClass="p-datatable-striped p-datatable-sm"
        responsiveLayout="stack"
        [breakpoint]="'960px'"
        dataKey="costId"
        [paginator]="true"
        [rows]="itemsPerPage"
        [totalRecords]="totalItems"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
        [rowsPerPageOptions]="[5, 10, 25, 50]"
        (onLazyLoad)="onPageChange($event)"
        lazy="true"
      >
        <ng-template pTemplate="header">
          <tr class="bg-gradient-to-r from-gray-50 to-gray-100">
            <th class="py-4 px-4 min-w-[120px]">
              <div class="flex items-center gap-2">
                <i class="pi pi-tag text-gray-500"></i>
                Type
              </div>
            </th>
            <th class="py-4 px-4 min-w-[200px]">
              <div class="flex items-center gap-2">
                <i class="pi pi-briefcase text-gray-500"></i>
                Mission
              </div>
            </th>
            <th class="py-4 px-4 min-w-[120px]">
              <div class="flex items-center gap-2">
                <i class="pi pi-dollar text-gray-500"></i>
                Amount
              </div>
            </th>
            <th class="py-4 px-4 min-w-[150px]">
              <div class="flex items-center gap-2">
                <i class="pi pi-calendar text-gray-500"></i>
                Date
              </div>
            </th>
            <th class="py-4 px-4 min-w-[120px]">
              <div class="flex items-center gap-2">
                <i class="pi pi-image text-gray-500"></i>
                Receipts
              </div>
            </th>
            <th class="py-4 px-4 min-w-[150px]">
              <div class="flex items-center gap-2">
                <i class="pi pi-cog text-gray-500"></i>
                Actions
              </div>
            </th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-cost>
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="py-4 px-4">
              <p-tag 
                [value]="getTypeLabel(cost.type)" 
                [severity]="getTypeSeverity(cost.type)"
                styleClass="text-xs font-semibold"
              ></p-tag>
            </td>
            <td class="py-4 px-4">
              <div class="font-medium text-gray-900">
                {{ getMissionTitle(cost.missionId) }}
              </div>
            </td>
            <td class="py-4 px-4">
              <div class="font-bold text-green-600">
                ${{ cost.amount.toFixed(2) }}
              </div>
            </td>
            <td class="py-4 px-4">
              <div class="text-gray-600">
                {{ cost.date | date: 'MMM dd, yyyy' }}
              </div>
            </td>
            <td class="py-4 px-4">
              <div class="flex items-center gap-2">
                <span class="text-sm text-gray-500">
                  {{ cost.receiptPhotoUrls?.length || 0 }} photos
                </span>
                <button
                  *ngIf="cost.receiptPhotoUrls && cost.receiptPhotoUrls.length > 0"
                  pButton
                  type="button"
                  icon="pi pi-eye"
                  class="p-button-text p-button-sm"
                  pTooltip="View Receipts"
                  (click)="viewPhotos(cost)"
                ></button>
              </div>
            </td>
            <td class="py-4 px-4">
              <div class="flex gap-2">
                <button
                  pButton
                  type="button"
                  icon="pi pi-pencil"
                  class="p-button-text p-button-sm p-button-primary"
                  pTooltip="Edit"
                  (click)="showEditDialog(cost)"
                ></button>
                <button
                  pButton
                  type="button"
                  icon="pi pi-trash"
                  class="p-button-text p-button-sm p-button-danger"
                  pTooltip="Delete"
                  (click)="deleteCost(cost)"
                ></button>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="6" class="py-8 px-4 text-center">
              <div class="flex flex-col items-center gap-4 text-gray-500">
                <i class="pi pi-dollar text-4xl"></i>
                <div>
                  <p class="text-lg font-medium">No mission costs found</p>
                  <p class="text-sm">Start by adding your first mission cost</p>
                </div>
                <button
                  pButton
                  type="button"
                  icon="pi pi-plus"
                  label="Add Cost"
                  class="p-button-primary"
                  (click)="showAddDialog()"
                ></button>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Add/Edit Cost Dialog -->
  <p-dialog
    [(visible)]="displayDialog"
    [header]="isEditMode ? 'Edit Mission Cost' : 'Add Mission Cost'"
    [modal]="true"
    [style]="{ width: '600px' }"
    [draggable]="false"
    [resizable]="false"
    styleClass="modern-dialog"
  >
    <form [formGroup]="costForm" (ngSubmit)="saveCost()" class="space-y-4">
      <!-- Mission Selection -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">Mission</label>
        <p-dropdown
          formControlName="missionId"
          [options]="missions"
          optionLabel="service"
          optionValue="missionId"
          placeholder="Select mission"
          styleClass="w-full"
          [showClear]="true"
          inputStyleClass="p-3 text-sm bg-gray-50 border border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200"
          appendTo="body"
        >
          <ng-template pTemplate="selectedItem" let-mission>
            <div class="flex items-center gap-2">
              <i class="pi pi-briefcase text-indigo-600"></i>
              <span>{{ mission.service }} - {{ mission.requester }}</span>
            </div>
          </ng-template>
          <ng-template pTemplate="item" let-mission>
            <div class="flex items-center gap-2">
              <i class="pi pi-briefcase text-indigo-600"></i>
              <span>{{ mission.service }} - {{ mission.requester }}</span>
            </div>
          </ng-template>
        </p-dropdown>
      </div>

      <!-- Cost Type -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">Cost Type</label>
        <p-dropdown
          formControlName="type"
          [options]="typeOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Select cost type"
          styleClass="w-full"
          [showClear]="true"
          inputStyleClass="p-3 text-sm bg-gray-50 border border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200"
          appendTo="body"
        ></p-dropdown>
      </div>

      <!-- Amount -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">Amount ($)</label>
        <input
          pInputText
          type="number"
          formControlName="amount"
          placeholder="Enter amount"
          class="w-full p-3 text-sm bg-gray-50 border border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200"
          step="0.01"
          min="0.01"
        />
      </div>

      <!-- Date -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">Date</label>
        <div class="relative">
          <input
            type="date"
            formControlName="date"
            [max]="getCurrentDateString()"
            class="w-full p-3 text-sm bg-gray-50 border border-gray-200 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all duration-200 custom-date-input"
            placeholder="Select date"
          />
          <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
            <i class="pi pi-calendar text-gray-400"></i>
          </div>
        </div>
      </div>

      <!-- Receipt Photos -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">Receipt Photos (Optional)</label>
        <p-fileUpload
          #fileUpload
          [multiple]="true"
          [maxFileSize]="10485760"
          accept="image/*"
          [customUpload]="true"
          (onSelect)="onFileSelect($event)"
          (onClear)="uploadedFiles = []"
          chooseLabel="Choose Photos"
          cancelLabel="Clear"
          styleClass="w-full"
          [auto]="true"
        >
          <ng-template pTemplate="content">
            <div *ngIf="uploadedFiles.length > 0" class="mt-4">
              <h6 class="text-sm font-medium text-gray-700 mb-2">Selected Files:</h6>
              <div class="space-y-2">
                <div 
                  *ngFor="let file of uploadedFiles; let i = index" 
                  class="flex items-center justify-between p-2 bg-gray-50 rounded-lg"
                >
                  <div class="flex items-center gap-2">
                    <i class="pi pi-image text-indigo-600"></i>
                    <span class="text-sm text-gray-700">{{ file.name }}</span>
                    <span class="text-xs text-gray-500">({{ (file.size / 1024 / 1024).toFixed(2) }} MB)</span>
                  </div>
                  <button
                    type="button"
                    pButton
                    icon="pi pi-times"
                    class="p-button-text p-button-sm p-button-danger"
                    (click)="removeFile(file)"
                  ></button>
                </div>
              </div>
            </div>
          </ng-template>
        </p-fileUpload>
        <p class="text-xs text-gray-500 mt-1">
          Maximum 10 photos, 10MB each. Supported formats: JPEG, PNG, GIF
        </p>
      </div>
    </form>

    <ng-template pTemplate="footer">
      <div class="flex justify-end gap-3">
        <button
          pButton
          type="button"
          label="Cancel"
          class="p-button-outlined"
          (click)="closeDialog()"
        ></button>
        <button
          pButton
          type="button"
          [label]="isEditMode ? 'Update' : 'Save'"
          [icon]="isEditMode ? 'pi pi-check' : 'pi pi-plus'"
          class="p-button-primary"
          [loading]="loading"
          [disabled]="costForm.invalid || loading"
          (click)="saveCost()"
        ></button>
      </div>
    </ng-template>
  </p-dialog>

  <!-- Photo Gallery Modal -->
  <p-dialog
    [(visible)]="showPhotoGallery"
    header="Receipt Photos"
    [modal]="true"
    [style]="{ width: '90vw', maxWidth: '800px', height: '80vh' }"
    [draggable]="false"
    [resizable]="false"
    styleClass="photo-gallery-dialog"
    (onHide)="closePhotoGallery()"
  >
    <div *ngIf="selectedPhotos.length > 0" class="relative h-full">
      <!-- Photo Navigation -->
      <div class="absolute top-4 left-4 z-10 flex items-center gap-2 bg-black bg-opacity-50 text-white px-3 py-2 rounded-lg">
        <span class="text-sm font-medium">
          {{ currentPhotoIndex + 1 }} / {{ selectedPhotos.length }}
        </span>
      </div>

      <!-- Close Button -->
      <button
        (click)="closePhotoGallery()"
        class="absolute top-4 right-4 z-10 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70 transition-all duration-200"
      >
        <i class="pi pi-times"></i>
      </button>

      <!-- Previous Button -->
      <button
        *ngIf="currentPhotoIndex > 0"
        (click)="previousPhoto()"
        class="absolute left-4 top-1/2 transform -translate-y-1/2 z-10 bg-black bg-opacity-50 text-white p-3 rounded-full hover:bg-opacity-70 transition-all duration-200"
      >
        <i class="pi pi-chevron-left"></i>
      </button>

      <!-- Next Button -->
      <button
        *ngIf="currentPhotoIndex < selectedPhotos.length - 1"
        (click)="nextPhoto()"
        class="absolute right-4 top-1/2 transform -translate-y-1/2 z-10 bg-black bg-opacity-50 text-white p-3 rounded-full hover:bg-opacity-70 transition-all duration-200"
      >
        <i class="pi pi-chevron-right"></i>
      </button>

      <!-- Current Photo -->
      <div class="flex items-center justify-center h-full">
        <img
          [src]="getImageUrl(selectedPhotos[currentPhotoIndex])"
          [alt]="'Receipt photo ' + (currentPhotoIndex + 1)"
          class="max-w-full max-h-full object-contain rounded-lg shadow-lg"
        />
      </div>

      <!-- Thumbnail Navigation -->
      <div *ngIf="selectedPhotos.length > 1" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 z-10">
        <div class="flex gap-2 bg-black bg-opacity-50 p-2 rounded-lg">
          <div
            *ngFor="let photo of selectedPhotos; let i = index"
            (click)="currentPhotoIndex = i"
            [class]="i === currentPhotoIndex ? 'ring-2 ring-white' : 'opacity-60 hover:opacity-100'"
            class="w-16 h-16 rounded-lg overflow-hidden cursor-pointer transition-all duration-200"
          >
            <img
              [src]="getImageUrl(photo)"
              [alt]="'Thumbnail ' + (i + 1)"
              class="w-full h-full object-cover"
            />
          </div>
        </div>
      </div>
    </div>
  </p-dialog>
</div> 